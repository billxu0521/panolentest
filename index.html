<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width, shrink-to-fit=no">
    <title>環景展廳</title>
    <div id="dialog">
      <div id="typed"></div>
    </div>

    <script src="asset/js/three/three.min.js"></script>
    <script src="asset/js/panolens/panolens.min.js"></script>
    <script src="asset/js/three/loaders/ColladaLoader.js"></script>
    <script src="asset/js/typed.min.js"></script>
    <script src='https://code.responsivevoice.org/responsivevoice.js'></script>

    <style>
      html, body {
        margin: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background-color: #000;
      }

      #typed {
        color: #fff;
        text-shadow: 0px 0px 2px #000;
        font-size: 16pt;
      }

      #panel {
        color: #fff;
        text-shadow: 0px 0px 2px #000;
        font-size: 16pt;
      }

      #dialog {
        position: absolute;
        top: 5%;
        width: 40%;
        
        padding: 10px;
        box-sizing: border-box;
        pointer-events: none;
      }

      #progress {
        width: 0;
        height: 5px;
        position: fixed;
        top: 0;
        background: #fff;
        -webkit-transition: opacity 0.5s ease;
        transition: opacity 0.5s ease;
      }
    </style>
  </head>

  <body>
    <script>
     
      const dataUrl = "https://billxu0521.github.io/panolentest/asset/data.json?zdksdl";
      //const dataUrl = "http://omekas.ccstw.nccu.edu.tw/api/items?item_set_id=10520";
      const fontUrl = "https://billxu0521.github.io/panolentest/asset/fonts/helvetiker_regular.typeface.json"
      const getImageList = ( url ) => {
        //開始取圖片資料
      return fetch( url )
        .then( response => response.json() )
        .then( onListReady )
        //.then( createWidget )
        .catch( console.error );
        
      };

      //打字效果
      function type ( stringArray  ) {

        var typeSpeed = 50;
        typed = new Typed( "#typed", {
          strings: stringArray,
          typeSpeed: typeSpeed,
          showCursor: false,
          backSpeed: 0,       
        });
      }

      function makeMultiLine ( text = '', count = 40 ) {

        let lineCharacterLimit = 0;

        return text.split(' ').map( word => {
          lineCharacterLimit += word.length;     
          if ( lineCharacterLimit > count ) {
            word += '\n';           
            lineCharacterLimit = 0;
          }
          return word;
        }).join(' ').replace( /\n /g, '\n' );

      }

      function createTextShape ( message, size = 10, count ) {

        message = makeMultiLine( message, count );
        var shapes = font.generateShapes( message, size );
        var geometry = new THREE.ShapeGeometry( shapes );
        var matLite = new THREE.MeshBasicMaterial( {
          color: 0xffffff,
          transparent: true,
          opacity: 1,
          side: THREE.DoubleSide
        } );

        geometry.computeBoundingBox();

        var xMid = - 0.1 * ( geometry.boundingBox.max.x - geometry.boundingBox.min.x );
        geometry.translate( xMid, 0, 0 );

        return new THREE.Mesh( geometry, matLite );

      }


      function createTitleAndDesc ( angle ,description,radius,pos) {
        var descSprite;
        //  description
        descSprite = createTextShape( description, 1);
        //descSprite.position.set( radius * Math.sin( -angle ), 0, radius * Math.cos( -angle ) );
        descSprite.material.opacity = 1;
        descSprite.position.y = -45;
        //descSprite.rotation.y = 0;
        descSprite.position.set(pos["x"],pos["y"],pos["z"] );
        descSprite.rotation.y = -60;
        descSprite.position.z = 10;
        descSprite.scale.multiplyScalar( 0.5 );
        descSprite.addEventListener( 'click', function () {
            //type(['',description]);
            var worldPosition = new THREE.Vector3();
            console.log(descSprite.getWorldPosition(worldPosition));

          } );
        return descSprite;

      }

      const onListReady = ( list ) => {
        console.log(list)
        const length = list.length;
        const radius = panorama.edgeLength / 2;
        var platdesccheck = false;
        list.map( ( item, index ) => {
          console.log(item)
          //imageitem = fetch( item['@id'] ).then(getItemContext).catch( console.error );
          imageurl = item.url;          
          var descriptionlist = item.description;
          //coeator = item['dcterms:creator'][0]['@value']
          //var descriptionlist = item["dcterms:description"].map(function(e,i,arr){return e["@value"];});
          //var description = descriptionlist.map(function(e,i,arr){return e+"<br>";});
          
          //var description = descriptionlist.map(function(e,i,arr){return e["@value"];});
          var description = descriptionlist.toString();

          var typed = new Typed('#typed',{
            strings: ["",description],
            showCursor: false,
            typeSpeed: 0,
            backSpeed: 0,
            backDelay: 500,
            startDelay: 1000,
            onBegin: function(self) {
            },
            onComplete: function(self) {
            },
            preStringTyped: function(pos, self) {
            },
            onStringTyped: function(pos, self) {
            },
            onLastStringBackspaced: function(self) {
            },
            onTypingPaused: function(pos, self) {
            },
            onTypingResumed: function(pos, self) {
            },
            onReset: function(self) {
            },
            onStop: function(pos, self) {
            },
            onStart: function(pos, self) {
            },
            onDestroy: function(self) {
            }
          });
          
          var tile = item.title;
          //建立提示點
          const infospot = new PANOLENS.Infospot( 500, imageurl);
          const new_infospot = new PANOLENS.Infospot( 100, null );
          new_infospot.addHoverText( description ,-200);
          infospot.addHoverText( tile ,100);
          //infospot.childinfospot = new_infospot
          //infospot.addHoverElement( panel, 200 );


          level = 0
          const theta = Math.random() * 2 * Math.PI;
          const phi = Math.random() * Math.PI;
          const angle = Math.PI / 6 * index + Math.PI;
          
          level = level + parseInt(index / 10) * 1500;
          r = 100;
          
          const alignPos = new THREE.Vector3(
            -radius * Math.sin( angle ), 0, radius * Math.cos( angle )
          );
          new_infospot.position.copy( new THREE.Vector3(
            -radius * Math.sin( angle ), -400, radius * Math.cos( angle )
          ));
          infospot.position.copy( alignPos );
          
          //desc = createTitleAndDesc(angle,"Hello!",radius,alignPos);
          //infospot.dec = desc;
          //console.log(infospot)
          //依序排列
          infospot.align = () => {
            new TWEEN.Tween( infospot.position )
            .to( alignPos, 1000 )
            .easing( TWEEN.Easing.Exponential.Out )
            .start();
            
          };
          
          infospot.addEventListener( 'hoverleave', function () {
            platdesccheck = false;
            typed.reset();
            typed.stop();
            responsiveVoice.cancel();
          } );

          infospot.addEventListener( 'click', function () {
            if(platdesccheck === false){
              platdesccheck = true;
              typed.reset();
              typed.start();
              console.log(description);
              responsiveVoice.speak(description, 'Chinese Female', {
                    rate: 1.0,
                });
            }
            var worldPosition = new THREE.Vector3();
            console.log(infospot.getWorldPosition(worldPosition));

          } );
          panorama.add( infospot );
          panorama.add( new_infospot );
          //panorama.add( desc );
          typed.stop();
        });
        viewer.add( panorama );
      };

      //建立環景場景
      //const panorama = new PANOLENS.BasicPanorama();
      const panorama = new PANOLENS.ImagePanorama( 'https://pchen66.github.io/Panolens/examples/asset/textures/equirectangular/field.jpg' );
      const viewer = new PANOLENS.Viewer( { enableReticle: true, renderer: new THREE.WebGLRenderer({antialias: true}),output: 'console' } );

      viewer.reticle.setColor( 0x77ffff );
      viewer.add( panorama );


      
      
      var loader = new THREE.FontLoader();
      loader.load( fontUrl, onFontLoaded );
      function onFontLoaded ( _font ) {
        //啟動各種功能
        
        font = _font;
        getImageList( dataUrl );
      
      }

      
      

    </script>
    


    
  </body>

</html>