<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width, shrink-to-fit=no">
    <title>環景展廳</title>
    <div id="dialog">
      <div id="typed">Hello</div>
    </div>
    
    </div>

    <script src="asset/js/three/three.min.js"></script>
    <script src="asset/js/panolens/panolens.min.js"></script>
    <script src="asset/js/three/loaders/ColladaLoader.js"></script>
    <script src="asset/js/typed.min.js"></script>
    <style>
      html, body {
        margin: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background-color: #000;
      }

      #typed {
        color: #fff;
        text-shadow: 0px 0px 2px #000;
        font-size: 16pt;
      }

      #dialog {
        position: absolute;
        top: 5%;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        box-sizing: border-box;
        pointer-events: none;
      }

      #progress {
        width: 0;
        height: 5px;
        position: fixed;
        top: 0;
        background: #fff;
        -webkit-transition: opacity 0.5s ease;
        transition: opacity 0.5s ease;
      }
    </style>
  </head>

  <body>
    <script>
      const dataUrl = "http://omekas.ccstw.nccu.edu.tw/api/items?item_set_id=10520";
      const fontUrl = "https://billxu0521.github.io/panolentest/asset/fonts/Microsoft_YaHei_Regular.json"
      const getRandomImageList = ( url ) => {
        //開始取圖片資料
      return fetch( url )
        .then( response => response.json() )
        .then( onListReady )
        .then( createWidget )
        .catch( console.error );
        
      };

      //打字效果
      function type ( stringArray  ) {

        var typeSpeed = 100;
        typed = new Typed( "#typed", {
          strings: stringArray,

          typeSpeed: typeSpeed,
          showCursor: false,
          startDelay: 300,
         
        });

      }


      function makeMultiLine ( text = '', count = 40 ) {

        let lineCharacterLimit = 0;

        return text.split(' ').map( word => {
          lineCharacterLimit += word.length;     
          if ( lineCharacterLimit > count ) {
            word += '\n';           
            lineCharacterLimit = 0;
          }
          return word;
        }).join(' ').replace( /\n /g, '\n' );

      }

      function createTextShape ( message, size = 10, count ) {

        message = makeMultiLine( message, count );
        console.log(font)
        var shapes = font.generateShapes( message, size );
        var geometry = new THREE.ShapeGeometry( shapes );
        var matLite = new THREE.MeshBasicMaterial( {
          color: 0xffffff,
          transparent: true,
          opacity: 1,
          side: THREE.DoubleSide
        } );

        geometry.computeBoundingBox();

        var xMid = - 0.1 * ( geometry.boundingBox.max.x - geometry.boundingBox.min.x );
        geometry.translate( xMid, 0, 0 );

        return new THREE.Mesh( geometry, matLite );

      }


      function createTitleAndDesc ( angle ,description,radius,pos) {
        var descSprite;
        //  description
        descSprite = createTextShape( description, 3 );
        //descSprite.position.set( radius * Math.sin( -angle ), 0, radius * Math.cos( -angle ) );
        descSprite.material.opacity = 1;
        //descSprite.position.y += 45;
        descSprite.rotation.y = 90;
        descSprite.position.set(pos["x"],pos["y"],pos["z"] );
        //descSprite.rotation.y = 90;
        descSprite.position.z = -5;
        descSprite.scale.multiplyScalar( 0.1 );
        
        return descSprite;

      }

      const onListReady = ( list ) => {
        
        const length = list.length;
        const radius = panorama.edgeLength / 2;

        list.map( ( item, index ) => {
          //imageitem = fetch( item['@id'] ).then(getItemContext).catch( console.error );
          imageurl = item.thumbnail_display_urls.large;          
          //coeator = item['dcterms:creator'][0]['@value']
          var descriptionlist = item["dcterms:description"].map(function(e,i,arr){return e["@value"];});
          var description = descriptionlist.map(function(e,i,arr){return e+"<br>";});
          
          //var description = descriptionlist.map(function(e,i,arr){return e["@value"];});
          description = description.toString();
          var tile = item["dcterms:title"][0]["@value"];

          const infospot = new PANOLENS.Infospot( 1000, imageurl);
          infospot.addHoverText( tile );
          level = 0
          const theta = Math.random() * 2 * Math.PI;
          const phi = Math.random() * Math.PI;
          const angle = index / length * 5 * Math.PI;
          
          level = level + parseInt(index / 10) * 1500;
          r = 100;
          const randomPos = new THREE.Vector3(
            radius * Math.sin( phi ) * Math.cos( theta ),
            radius * Math.sin( phi ) * Math.sin( theta ),
            radius * Math.cos( phi )
          );
          const alignPos = new THREE.Vector3(
            radius * Math.cos( angle ) ,
            level ,
            radius * Math.sin( angle ) 
          );
          infospot.position.copy( alignPos );
          
          desc = createTitleAndDesc(angle,description,radius,alignPos);
          infospot.dec = desc;
          console.log(infospot)
          //依序排列
          infospot.align = () => {
            new TWEEN.Tween( infospot.position )
            .to( alignPos, 1000 )
            .easing( TWEEN.Easing.Exponential.Out )
            .start();
            console.log("align")
            
          };
          //隨機排列
          infospot.randomize = () => {
            new TWEEN.Tween( infospot.position )
            .to( randomPos, 1000 )
            .easing( TWEEN.Easing.Exponential.Out )
            .start();
            console.log("randomize")
          };
          
          infospot.addEventListener( 'click', function () {
            //type(['',description]);
          } );
          panorama.add( desc );
          panorama.add( infospot );

        });
        viewer.add( panorama );
      };

      const createWidget = () => {

      const onImage = 'url("https://i.imgur.com/k5Mp1Q9.png")';
      const offImage = 'url("https://i.imgur.com/laX1DBL.png")';

      const widget = { 
        style: { backgroundImage: onImage },
        onTap: () => {
          const enabledGrid = item.style.backgroundImage == onImage;
          panorama.children.forEach( infospot => infospot[ enabledGrid ? 'align' : 'randomize' ]() );
          item.style.backgroundImage = enabledGrid ? offImage : onImage;
        }
      };

      const item = viewer.appendControlItem( widget );

      };

      //建立環景場景
      const panorama = new PANOLENS.BasicPanorama();
      //const panorama = new PANOLENS.ImagePanorama( 'https://pchen66.github.io/Panolens/examples/asset/textures/equirectangular/field.jpg' );
      const viewer = new PANOLENS.Viewer( { enableReticle: true, renderer: new THREE.WebGLRenderer({antialias: true}),output: 'console' } );

      viewer.reticle.setColor( 0x77ffff );
      viewer.add( panorama );

      
      var loader = new THREE.FontLoader();
      loader.load( fontUrl, onFontLoaded );
      function onFontLoaded ( _font ) {
        //啟動各種功能
        
        font = _font;
        getRandomImageList( dataUrl );
      
      }



    </script>
    


    
  </body>

</html>